<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ®ï¸ Gamdori</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg0:#070812;
      --bg1:#0b1030;
      --neon:#7c4dff;
      --neon2:#00e5ff;
      --good:#38ef7d;
      --bad:#ff4d6d;
      --warn:#ffd54f;
      --card:#0f173a;
      --panel:#0b122c;
      --text:#e9ecff;
      --muted:#a9b2ff;
      --glow: 0 0 10px rgba(124,77,255,.55), 0 0 30px rgba(0,229,255,.25);
      --glow-strong: 0 0 12px rgba(124,77,255,.85), 0 0 40px rgba(0,229,255,.35);
    }

    body{
      min-height:100vh;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(124,77,255,.25), transparent 55%),
        radial-gradient(800px 520px at 85% 20%, rgba(0,229,255,.16), transparent 55%),
        radial-gradient(900px 520px at 40% 90%, rgba(56,239,125,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    .wrap{ max-width: 980px; margin: 0 auto; }

    .neon-title{
      letter-spacing: .5px;
      text-shadow: var(--glow-strong);
    }

    .glass{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }

    .machine{
      background: linear-gradient(180deg, rgba(124,77,255,.12), rgba(0,229,255,.06));
      border: 1px solid rgba(124,77,255,.22);
      box-shadow: var(--glow);
    }

    .chip{
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.2rem .55rem;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size:.85rem;
      white-space:nowrap;
    }

    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
    }

    /* Slot reels */
    .reels{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 12px;
      align-items:center;
      justify-content:center;
    }

    .reel{
      height: 110px;
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      box-shadow: inset 0 0 0 1px rgba(124,77,255,.10), var(--glow);
      position: relative;
      overflow:hidden;
    }

    .reel::before{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.15), transparent 20%, transparent 80%, rgba(0,0,0,.25));
      pointer-events:none;
    }

    .reel .window{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 56px;
      font-weight: 800;
      text-shadow: var(--glow-strong);
    }

    .reel .stack{
      position:absolute;
      left:0; right:0;
      top:0;
      will-change: transform;
      opacity: .85;
      filter: blur(.2px);
    }

    .reel .stack .n{
      height: 110px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 52px;
      font-weight: 800;
      color: rgba(233,236,255,.85);
      text-shadow: var(--glow);
    }

    .op{
      font-size: 44px;
      font-weight: 900;
      text-shadow: var(--glow-strong);
      padding: 0 4px;
      color: rgba(233,236,255,.95);
      user-select:none;
    }

    .question-line{
      font-size: 26px;
      font-weight: 700;
      letter-spacing: .3px;
      text-shadow: var(--glow);
    }

    .pulse{
      animation:pulse 650ms ease-in-out;
    }
    @keyframes pulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.03)}
      100%{transform:scale(1)}
    }

    .shake{
      animation:shake 340ms ease-in-out;
    }
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-6px)}
      50%{transform:translateX(6px)}
      75%{transform:translateX(-4px)}
      100%{transform:translateX(0)}
    }

    .blink{
      animation:blink 650ms steps(1,end) infinite;
    }
    @keyframes blink{
      50%{ opacity:.45; }
    }

    .timer-ring{
      --p: 0%;
      width: 56px;
      height: 56px;
      border-radius: 999px;
      background:
        conic-gradient(var(--neon2) var(--p), rgba(255,255,255,.12) 0);
      display:grid;
      place-items:center;
      box-shadow: var(--glow);
      border: 1px solid rgba(255,255,255,.12);
    }
    .timer-ring > div{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      background: rgba(0,0,0,.30);
      border: 1px solid rgba(255,255,255,.10);
      display:grid;
      place-items:center;
      color: var(--text);
      font-weight: 800;
    }

    .table-darkish{
      --bs-table-bg: rgba(0,0,0,.22);
      --bs-table-border-color: rgba(255,255,255,.10);
      --bs-table-color: var(--text);
    }

    .btn-neon{
      background: linear-gradient(90deg, rgba(124,77,255,.90), rgba(0,229,255,.75));
      border: 0;
      color: #071026;
      font-weight: 800;
      box-shadow: var(--glow);
    }
    .btn-neon:disabled{ opacity:.55; box-shadow:none; }

    .form-control, .form-select{
      background: rgba(0,0,0,.22);
      border-color: rgba(255,255,255,.14);
      color: var(--text);
    }
    .form-control::placeholder{ color: rgba(233,236,255,.45); }
    .form-control:focus, .form-select:focus{
      border-color: rgba(0,229,255,.55);
      box-shadow: 0 0 0 .25rem rgba(0,229,255,.15);
      background: rgba(0,0,0,.22);
      color: var(--text);
    }

    .badge-soft{
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      color: var(--text);
    }
  </style>
</head>

<body class="py-4">
  <div class="wrap px-3">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-3">
      <div>
        <h1 class="h3 mb-1 neon-title">ì—°ì‚°xì—°ì‚° <span class="text-white-50">ê²œë„ë¦¬ ğŸ®ï¸</span></h1>
        <div class="text-white-50 small">
          ìë¦¬ìˆ˜ í™•ë¥ : <span class="mono">1&1(30%) / 1&2(50%) / 2&2(20%)</span> Â· ë²”ìœ„: <span class="mono">1~99</span>
        </div>
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button id="btnStart" class="btn btn-neon">ì‹œì‘</button>
        <button id="btnRestartStage" class="btn btn-outline-light">í˜„ì¬ ë‹¨ê³„ ì¬ì‹œì‘</button>
        <button id="btnRestartAll" class="btn btn-outline-warning">ì²˜ìŒë¶€í„°</button>
      </div>
    </div>

    <div class="row g-3">
      <!-- Left: Machine -->
      <div class="col-12 col-lg-7">
        <div class="card glass machine border-0">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
              <div class="d-flex flex-wrap gap-2">
                <span class="chip"><span class="badge badge-soft">Stage</span> <span id="hudStage" class="mono fw-bold">-</span></span>
                <span class="chip"><span class="badge badge-soft">Rule</span> <span id="hudRule" class="mono fw-bold">-</span></span>
                <span class="chip"><span class="badge badge-soft">Need</span> <span id="hudNeed" class="mono fw-bold">-</span></span>
                <span class="chip"><span class="badge badge-soft">Remain</span> <span id="hudRemain" class="mono fw-bold">-</span></span>
              </div>

              <div class="d-flex align-items-center gap-2">
                <div class="timer-ring" id="timerRing" style="--p:0%;">
                  <div class="mono" id="timerText">-</div>
                </div>
                <div>
                  <div class="text-white-50 small">ì‹œê°„ ì œí•œ</div>
                  <div class="mono fw-bold"><span id="hudTimeLimit">-</span>s</div>
                </div>
              </div>
            </div>

            <div class="progress mb-3" style="height: 10px; background: rgba(255,255,255,.10);">
              <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
            </div>

            <!-- Slot Reels -->
            <div class="p-3 rounded-4" style="background: rgba(0,0,0,.20); border: 1px solid rgba(255,255,255,.10);">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="text-white-50 small">SLOT</div>
                <div class="d-flex flex-wrap gap-2">
                  <span class="chip"><span class="badge badge-soft">Streak</span> <span id="hudStreak" class="mono fw-bold">0</span></span>
                  <span class="chip"><span class="badge badge-soft">Score</span> <span id="hudScore" class="mono fw-bold">0</span></span>
                </div>
              </div>

              <div class="reels mb-3">
                <div class="reel" id="reelA">
                  <div class="stack" id="stackA"></div>
                  <div class="window mono" id="windowA">-</div>
                </div>

                <div class="op mono" id="opSymbol">?</div>

                <div class="reel" id="reelB">
                  <div class="stack" id="stackB"></div>
                  <div class="window mono" id="windowB">-</div>
                </div>
              </div>

              <div class="d-flex justify-content-center mb-2">
                <div class="question-line mono text-center" id="questionLine">ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
              </div>

              <div class="text-center">
                <span id="spinBadge" class="badge text-bg-secondary mono d-none blink">SPINNING...</span>
              </div>
            </div>

            <form id="answerForm" class="row g-2 align-items-center mt-3">
              <div class="col-12 col-md-8">
                <input id="answerInput" class="form-control form-control-lg mono" type="number" inputmode="numeric" placeholder="ì •ë‹µ ì…ë ¥" disabled />
              </div>
              <div class="col-12 col-md-4 d-grid">
                <button id="btnSubmit" class="btn btn-success btn-lg" type="submit" disabled>ì œì¶œ</button>
              </div>
            </form>
            <div class="form-text text-white-50">Enterë¡œ ì œì¶œ / Escë¡œ ì²˜ìŒë¶€í„°</div>
          </div>
        </div>
      </div>

      <!-- Right: Controls + Log -->
      <div class="col-12 col-lg-5">
        <div class="card glass border-0 mb-3">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
              <div class="fw-bold">ë ˆë²¨ ì„ íƒ</div>
              <span class="text-white-50 small">ì„ íƒ í›„ ì‹œì‘</span>
            </div>

            <div class="row g-2 align-items-end">
              <div class="col-7">
                <label class="form-label text-white-50 mb-1">ì‹œì‘ ë‹¨ê³„</label>
                <select id="stageSelect" class="form-select">
                  <option value="1">1ë‹¨ê³„ (ë§ì…ˆ) Â· ëŒ€ê¸°3ì´ˆ Â· 5íšŒ</option>
                  <option value="2">2ë‹¨ê³„ (ëº„ì…ˆ) Â· ëŒ€ê¸°3ì´ˆ Â· 5íšŒ</option>
                  <option value="3">3ë‹¨ê³„ (ë‚˜ëˆ—ì…ˆ-ëª«) Â· ëŒ€ê¸°5ì´ˆ Â· 3íšŒ</option>
                  <option value="4">4ë‹¨ê³„ (ê³±ì…ˆ) Â· ëŒ€ê¸°5ì´ˆ Â· 3íšŒ</option>
                </select>
              </div>
              <div class="col-5">
                <label class="form-label text-white-50 mb-1">ì‚¬ìš´ë“œ</label>
                <select id="soundSelect" class="form-select">
                  <option value="on" selected>ON</option>
                  <option value="off">OFF</option>
                </select>
              </div>
            </div>

            <hr style="border-color: rgba(255,255,255,.12);" />

            <div class="d-flex flex-wrap gap-2">
              <span class="chip"><span class="badge badge-soft">ì •ë‹µ</span> <span id="hudCorrect" class="mono fw-bold">0</span></span>
              <span class="chip"><span class="badge badge-soft">ì˜¤ë‹µ</span> <span id="hudWrong" class="mono fw-bold">0</span></span>
              <span class="chip"><span class="badge badge-soft">íƒ€ì„ì•„ì›ƒ</span> <span id="hudTimeout" class="mono fw-bold">0</span></span>
              <span class="chip"><span class="badge badge-soft">ì´ ì‹œë„</span> <span id="hudAttempt" class="mono fw-bold">0</span></span>
            </div>

            <div class="mt-3 small text-white-50">
              <div class="fw-semibold text-white mb-1">ë‹¨ê³„ ê·œì¹™</div>
              <ul class="mb-0">
                <li>1: ë§ì…ˆ / 3ì´ˆ ëŒ€ê¸° / 5íšŒ ì •ë‹µ</li>
                <li>2: ëº„ì…ˆ(ìŒìˆ˜ ë°©ì§€) / 3ì´ˆ ëŒ€ê¸° / 5íšŒ ì •ë‹µ</li>
                <li>3: ë‚˜ëˆ—ì…ˆ(ëª«) / 5ì´ˆ ëŒ€ê¸° / 3íšŒ ì •ë‹µ (ë‚˜ëˆ„ì–´ë–¨ì–´ì§)</li>
                <li>4: ê³±ì…ˆ / 5ì´ˆ ëŒ€ê¸° / 3íšŒ ì •ë‹µ</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="card glass border-0">
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
              <div class="fw-bold">ë¬¸ì œ/ì •ë‹µ ë¡œê·¸</div>
              <div class="d-flex gap-2">
                <button id="btnDownloadCsv" class="btn btn-outline-light btn-sm">CSV</button>
                <button id="btnClearLog" class="btn btn-outline-danger btn-sm">ë¹„ìš°ê¸°</button>
              </div>
            </div>

            <div class="table-responsive" style="max-height: 360px;">
              <table class="table table-sm table-darkish align-middle mb-0">
                <thead style="position: sticky; top: 0; background: rgba(10,15,35,.95);">
                  <tr>
                    <th class="text-white-50">#</th>
                    <th class="text-white-50">Stage</th>
                    <th class="text-white-50">ë¬¸ì œ</th>
                    <th class="text-white-50">ì…ë ¥</th>
                    <th class="text-white-50">ì •ë‹µ</th>
                    <th class="text-white-50">ê²°ê³¼</th>
                    <th class="text-white-50">ë‚¨ì€ì‹œê°„</th>
                  </tr>
                </thead>
                <tbody id="logBody">
                  <tr><td colspan="7" class="text-white-50">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                </tbody>
              </table>
            </div>

            <div class="text-white-50 small mt-2">
              íŒ: <span class="mono">Enter</span>ë¡œ ì œì¶œ, <span class="mono">Esc</span>ë¡œ ì²˜ìŒë¶€í„° ë¦¬ì…‹
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
      <div id="toast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div id="toastBody" class="toast-body">-</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --------------------------------------------
    // Config
    // --------------------------------------------
    const STAGES = [
      { stage: 1, op: '+', name: 'ë§ì…ˆ', waitSec: 3, needCorrect: 5, timeLimitSec: 6 },
      { stage: 2, op: '-', name: 'ëº„ì…ˆ', waitSec: 3, needCorrect: 5, timeLimitSec: 7 },
      { stage: 3, op: 'Ã·', name: 'ë‚˜ëˆ—ì…ˆ(ëª«)', waitSec: 5, needCorrect: 3, timeLimitSec: 8 },
      { stage: 4, op: 'Ã—', name: 'ê³±ì…ˆ', waitSec: 5, needCorrect: 3, timeLimitSec: 8 },
    ];

    const DIGIT_PAIR_WEIGHTS = [
      { key: '1-1', p: 0.30 },
      { key: '1-2', p: 0.50 },
      { key: '2-2', p: 0.20 },
    ];

    const LOG_LIMIT = 150;

    // --------------------------------------------
    // DOM
    // --------------------------------------------
    const btnStart = document.getElementById('btnStart');
    const btnRestartStage = document.getElementById('btnRestartStage');
    const btnRestartAll = document.getElementById('btnRestartAll');

    const stageSelect = document.getElementById('stageSelect');
    const soundSelect = document.getElementById('soundSelect');

    const hudStage = document.getElementById('hudStage');
    const hudRule = document.getElementById('hudRule');
    const hudNeed = document.getElementById('hudNeed');
    const hudRemain = document.getElementById('hudRemain');
    const hudTimeLimit = document.getElementById('hudTimeLimit');

    const hudStreak = document.getElementById('hudStreak');
    const hudScore = document.getElementById('hudScore');
    const hudCorrect = document.getElementById('hudCorrect');
    const hudWrong = document.getElementById('hudWrong');
    const hudTimeout = document.getElementById('hudTimeout');
    const hudAttempt = document.getElementById('hudAttempt');

    const progressBar = document.getElementById('progressBar');

    const reelA = document.getElementById('reelA');
    const reelB = document.getElementById('reelB');
    const stackA = document.getElementById('stackA');
    const stackB = document.getElementById('stackB');
    const windowA = document.getElementById('windowA');
    const windowB = document.getElementById('windowB');
    const opSymbol = document.getElementById('opSymbol');
    const questionLine = document.getElementById('questionLine');
    const spinBadge = document.getElementById('spinBadge');

    const answerForm = document.getElementById('answerForm');
    const answerInput = document.getElementById('answerInput');
    const btnSubmit = document.getElementById('btnSubmit');

    const timerRing = document.getElementById('timerRing');
    const timerText = document.getElementById('timerText');

    const logBody = document.getElementById('logBody');
    const btnClearLog = document.getElementById('btnClearLog');
    const btnDownloadCsv = document.getElementById('btnDownloadCsv');

    const toastEl = document.getElementById('toast');
    const toastBody = document.getElementById('toastBody');
    const toast = new bootstrap.Toast(toastEl, { delay: 1700 });

    // --------------------------------------------
    // Audio (WebAudio) - slot-ish beeps
    // --------------------------------------------
    const AudioFX = (() => {
      let ctx = null;
      function ensure() {
        if (!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
        return ctx;
      }
      function enabled() {
        return soundSelect.value !== 'off';
      }
      function beep({ freq = 440, dur = 0.08, type = 'sine', gain = 0.06 } = {}) {
        if (!enabled()) return;
        const c = ensure();
        const t0 = c.currentTime;

        const o = c.createOscillator();
        const g = c.createGain();

        o.type = type;
        o.frequency.value = freq;

        g.gain.setValueAtTime(0.0001, t0);
        g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

        o.connect(g).connect(c.destination);
        o.start(t0);
        o.stop(t0 + dur + 0.02);
      }
      function sequence(steps) {
        if (!enabled()) return;
        const c = ensure();
        let at = c.currentTime;
        for (const s of steps) {
          const o = c.createOscillator();
          const g = c.createGain();
          o.type = s.type || 'sine';
          o.frequency.value = s.freq || 440;
          const dur = s.dur ?? 0.07;
          const gain = s.gain ?? 0.06;

          g.gain.setValueAtTime(0.0001, at);
          g.gain.exponentialRampToValueAtTime(gain, at + 0.008);
          g.gain.exponentialRampToValueAtTime(0.0001, at + dur);

          o.connect(g).connect(c.destination);
          o.start(at);
          o.stop(at + dur + 0.02);

          at += (dur + (s.gap ?? 0.02));
        }
      }

      return {
        unlock() { if (enabled()) ensure().resume?.(); },
        spinTick() { beep({ freq: 820 + Math.random()*120, dur: 0.03, type: 'square', gain: 0.03 }); },
        correct() { sequence([{freq:660,dur:.07,type:'triangle',gain:.07},{freq:880,dur:.09,type:'triangle',gain:.08},{freq:990,dur:.11,type:'sine',gain:.08}]); },
        wrong() { sequence([{freq:220,dur:.12,type:'sawtooth',gain:.06},{freq:180,dur:.14,type:'sawtooth',gain:.06}]); },
        timeout() { sequence([{freq:320,dur:.08,type:'square',gain:.05},{freq:240,dur:.16,type:'square',gain:.06}]); },
        stageUp() { sequence([{freq:523.25,dur:.08,type:'sine',gain:.06},{freq:659.25,dur:.08,type:'sine',gain:.06},{freq:783.99,dur:.12,type:'sine',gain:.07}]); },
      };
    })();

    // --------------------------------------------
    // State
    // --------------------------------------------
    const state = {
      running: false,
      stageIndex: 0,
      gotCorrectThisStage: 0,

      streak: 0,
      score: 0,

      correct: 0,
      wrong: 0,
      timeout: 0,
      attempt: 0,

      current: null, // { a,b,op,answer,display, stage, startedAt, timeLimitSec }
      lockInput: true,
      phase: 'idle', // idle | spinning | waiting | answering | finished

      timers: {
        spin: null,
        waitUnlock: null,
        questionTick: null,
        questionTimeout: null,
      },

      log: [],
      seq: 0,
    };

    // --------------------------------------------
    // Utils
    // --------------------------------------------
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function pickWeighted(items) {
      const r = Math.random();
      let acc = 0;
      for (const it of items) {
        acc += it.p;
        if (r <= acc) return it;
      }
      return items[items.length - 1];
    }

    function randByDigits(d) {
      return (d === 1) ? randInt(1, 9) : randInt(10, 99);
    }

    function pickDigitPair() {
      const { key } = pickWeighted(DIGIT_PAIR_WEIGHTS);
      const [d1, d2] = key.split('-').map(Number);
      if (d1 === 1 && d2 === 2) return (Math.random() < 0.5) ? [1, 2] : [2, 1];
      return [d1, d2];
    }

    function stageInfo() {
      return STAGES[state.stageIndex];
    }

    function setToast(msg, kind = 'dark') {
      toastEl.className = `toast align-items-center text-bg-${kind} border-0`;
      toastBody.textContent = msg;
      toast.show();
    }

    function clearTimers() {
      for (const k of Object.keys(state.timers)) {
        if (state.timers[k]) {
          if (k === 'spin' || k === 'questionTick') clearInterval(state.timers[k]);
          else clearTimeout(state.timers[k]);
        }
        state.timers[k] = null;
      }
    }

    function setInputLocked(locked) {
      state.lockInput = locked;
      answerInput.disabled = locked;
      btnSubmit.disabled = locked;
      if (!locked) {
        answerInput.focus();
        answerInput.select();
      }
    }

    function setRingProgress(pct, text) {
      timerRing.style.setProperty('--p', `${Math.max(0, Math.min(100, pct))}%`);
      timerText.textContent = text;
    }

    function updateHUD() {
      const info = stageInfo();
      hudStage.textContent = `${info.stage}`;
      hudRule.textContent = `${info.name} (${info.op})`;
      hudNeed.textContent = `${info.needCorrect}`;
      hudRemain.textContent = `${Math.max(0, info.needCorrect - state.gotCorrectThisStage)}`;
      hudTimeLimit.textContent = `${info.timeLimitSec}`;

      hudStreak.textContent = `${state.streak}`;
      hudScore.textContent = `${state.score}`;
      hudCorrect.textContent = `${state.correct}`;
      hudWrong.textContent = `${state.wrong}`;
      hudTimeout.textContent = `${state.timeout}`;
      hudAttempt.textContent = `${state.attempt}`;

      const pct = (state.gotCorrectThisStage / info.needCorrect) * 100;
      progressBar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
      progressBar.classList.toggle('bg-success', pct >= 100);
      progressBar.classList.toggle('bg-info', pct < 100);
    }

    // --------------------------------------------
    // Problem generation (same rules + division exact)
    // --------------------------------------------
    function makeProblemForStage(info) {
      const [dA, dB] = pickDigitPair();
      let a = randByDigits(dA);
      let b = randByDigits(dB);

      if (info.op === '+') {
        return { a, b, op: '+', answer: a + b, display: `${a} + ${b}` };
      }
      if (info.op === '-') {
        const x = Math.max(a, b);
        const y = Math.min(a, b);
        return { a: x, b: y, op: '-', answer: x - y, display: `${x} - ${y}` };
      }
      if (info.op === 'Ã—') {
        return { a, b, op: 'Ã—', answer: a * b, display: `${a} Ã— ${b}` };
      }
      if (info.op === 'Ã·') {
        const targetDividendDigits = dA;
        const targetDivisorDigits = dB;

        for (let tries = 0; tries < 5000; tries++) {
          const divisor = randByDigits(targetDivisorDigits);
          const quotient = randInt(1, 99);
          const dividend = divisor * quotient;
          if (dividend < 1 || dividend > 99) continue;

          const dividendDigits = (dividend <= 9) ? 1 : 2;
          const divisorDigits = (divisor <= 9) ? 1 : 2;

          if (dividendDigits !== targetDividendDigits) continue;
          if (divisorDigits !== targetDivisorDigits) continue;

          return { a: dividend, b: divisor, op: 'Ã·', answer: quotient, display: `${dividend} Ã· ${divisor}` };
        }

        // fallback
        const divisor = randInt(1, 9);
        const quotient = randInt(1, 9);
        const dividend = divisor * quotient;
        return { a: dividend, b: divisor, op: 'Ã·', answer: quotient, display: `${dividend} Ã· ${divisor}` };
      }
      throw new Error('Unknown op');
    }

    // --------------------------------------------
    // Slot animation helpers
    // --------------------------------------------
    function buildStack(el, count = 18) {
      el.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const n = document.createElement('div');
        n.className = 'n mono';
        n.textContent = String(randInt(0, 9));
        el.appendChild(n);
      }
    }

    function spinReelsOnce(targetA, targetB, op) {
      // Setup
      opSymbol.textContent = op;
      spinBadge.classList.remove('d-none');

      buildStack(stackA);
      buildStack(stackB);

      let posA = 0;
      let posB = 0;

      const speedA = 28 + Math.random()*10;
      const speedB = 24 + Math.random()*10;

      reelA.classList.add('pulse');
      reelB.classList.add('pulse');
      setTimeout(() => { reelA.classList.remove('pulse'); reelB.classList.remove('pulse'); }, 700);

      // Spin tick: just moving the stack up
      const startAt = performance.now();
      const spinMs = 900;      // base spin
      const slowMs = 520;      // slow down phase
      const totalMs = spinMs + slowMs;

      windowA.textContent = '-';
      windowB.textContent = '-';

      state.phase = 'spinning';
      setInputLocked(true);

      if (state.timers.spin) clearInterval(state.timers.spin);

      state.timers.spin = setInterval(() => {
        const t = performance.now() - startAt;
        const k = Math.max(0, Math.min(1, t / totalMs)); // 0..1

        // ease-out slowdown
        const ease = 1 - Math.pow(1 - k, 3);
        const factor = 1 - (ease * 0.85);

        posA += speedA * factor;
        posB += speedB * factor;

        stackA.style.transform = `translateY(${-posA}px)`;
        stackB.style.transform = `translateY(${-posB}px)`;

        AudioFX.spinTick();

        if (t >= totalMs) {
          clearInterval(state.timers.spin);
          state.timers.spin = null;
          spinBadge.classList.add('d-none');

          // reveal target
          windowA.textContent = String(targetA);
          windowB.textContent = String(targetB);

          // reset stacks (keep visuals clean)
          stackA.innerHTML = '';
          stackB.innerHTML = '';

          reelA.classList.add('pulse');
          reelB.classList.add('pulse');
          setTimeout(() => { reelA.classList.remove('pulse'); reelB.classList.remove('pulse'); }, 700);
        }
      }, 33);
    }

    // --------------------------------------------
    // Question lifecycle: spin -> wait -> answering (timer) -> submit/timeout -> next
    // --------------------------------------------
    function startQuestionTimer(timeLimitSec) {
      const startedAt = performance.now();
      const deadline = startedAt + timeLimitSec * 1000;

      // set ring initial
      setRingProgress(0, String(timeLimitSec));

      if (state.timers.questionTick) clearInterval(state.timers.questionTick);
      if (state.timers.questionTimeout) clearTimeout(state.timers.questionTimeout);

      state.timers.questionTick = setInterval(() => {
        const now = performance.now();
        const remainMs = Math.max(0, deadline - now);
        const remainSec = remainMs / 1000;

        const pct = (1 - (remainMs / (timeLimitSec * 1000))) * 100;
        const text = remainSec.toFixed(1);

        setRingProgress(pct, text);

        // warning vibe
        if (remainSec <= 2.0) {
          timerRing.style.boxShadow = '0 0 12px rgba(255,77,109,.65), 0 0 30px rgba(255,213,79,.18)';
        } else {
          timerRing.style.boxShadow = 'var(--glow)';
        }
      }, 60);

      state.timers.questionTimeout = setTimeout(() => {
        onTimeout();
      }, timeLimitSec * 1000);
    }

    function stopQuestionTimer() {
      if (state.timers.questionTick) clearInterval(state.timers.questionTick);
      if (state.timers.questionTimeout) clearTimeout(state.timers.questionTimeout);
      state.timers.questionTick = null;
      state.timers.questionTimeout = null;
      timerRing.style.boxShadow = 'var(--glow)';
    }

    function nextQuestion() {
      clearTimers();
      stopQuestionTimer();
      updateHUD();

      const info = stageInfo();
      const p = makeProblemForStage(info);

      state.current = {
        ...p,
        stage: info.stage,
        timeLimitSec: info.timeLimitSec,
        waitSec: info.waitSec,
        startedAt: null,
      };

      // Spin reels
      questionLine.textContent = 'SPIN...';
      questionLine.classList.add('blink');
      spinReelsOnce(state.current.a, state.current.b, info.op);

      // After spin ends, show question text + wait lock + then unlock
      state.timers.waitUnlock = setTimeout(() => {
        state.phase = 'waiting';

        questionLine.classList.remove('blink');
        questionLine.textContent = `${state.current.display} = ?`;
        questionLine.classList.add('pulse');
        setTimeout(() => questionLine.classList.remove('pulse'), 650);

        // wait phase lock (stage waitSec)
        setInputLocked(true);
        answerInput.value = '';

        const waitMs = info.waitSec * 1000;

        // show wait on ring: fill from 0->100 during wait, then start question timer
        const waitStart = performance.now();
        const waitEnd = waitStart + waitMs;

        setRingProgress(0, `${info.waitSec}`);

        state.timers.questionTick = setInterval(() => {
          const now = performance.now();
          const remain = Math.max(0, waitEnd - now);
          const pct = (1 - (remain / waitMs)) * 100;
          setRingProgress(pct, (remain/1000).toFixed(1));
          if (remain <= 0) {
            clearInterval(state.timers.questionTick);
            state.timers.questionTick = null;

            // Now answering phase
            state.phase = 'answering';
            state.current.startedAt = performance.now();
            setInputLocked(false);
            AudioFX.unlock();

            startQuestionTimer(info.timeLimitSec);
          }
        }, 60);
      }, 1500); // spin visual time buffer (matches reel spin duration)
    }

    function logAttempt({ input, result, remainSec }) {
      const info = stageInfo();
      state.seq += 1;

      const row = {
        no: state.seq,
        stage: info.stage,
        problem: `${state.current.display} = ?`,
        input: (input === null || input === undefined) ? '' : String(input),
        answer: String(state.current.answer),
        result,
        remainSec: (remainSec === null || remainSec === undefined) ? '' : remainSec.toFixed(1),
      };

      state.log.unshift(row);
      if (state.log.length > LOG_LIMIT) state.log.pop();
      renderLog();
    }

    function renderLog() {
      if (state.log.length === 0) {
        logBody.innerHTML = '<tr><td colspan="7" class="text-white-50">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }

      const escapeHtml = (s) => String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");

      logBody.innerHTML = state.log.map(r => {
        const badge =
          r.result === 'ì •ë‹µ' ? 'text-bg-success' :
          r.result === 'ì˜¤ë‹µ' ? 'text-bg-danger' :
          'text-bg-warning text-dark';

        return `
          <tr>
            <td class="mono text-white-50">${r.no}</td>
            <td class="mono">${r.stage}</td>
            <td class="mono">${escapeHtml(r.problem)}</td>
            <td class="mono">${escapeHtml(r.input)}</td>
            <td class="mono">${escapeHtml(r.answer)}</td>
            <td><span class="badge ${badge}">${escapeHtml(r.result)}</span></td>
            <td class="mono text-white-50">${escapeHtml(r.remainSec)}</td>
          </tr>
        `;
      }).join('');
    }

    function remainSecNow() {
      if (!state.current?.startedAt) return null;
      const limit = state.current.timeLimitSec;
      const elapsed = (performance.now() - state.current.startedAt) / 1000;
      return Math.max(0, limit - elapsed);
    }

    function onTimeout() {
      if (!state.running) return;
      if (state.phase !== 'answering') return;

      stopQuestionTimer();
      setInputLocked(true);

      state.attempt += 1;
      state.timeout += 1;
      state.streak = 0;
      state.score = Math.max(0, state.score - 1);

      AudioFX.timeout();
      setToast(`íƒ€ì„ì•„ì›ƒ! ì •ë‹µ: ${state.current.answer}`, 'warning');

      questionLine.classList.add('shake');
      setTimeout(() => questionLine.classList.remove('shake'), 380);

      logAttempt({ input: null, result: 'íƒ€ì„ì•„ì›ƒ', remainSec: 0 });

      updateHUD();
      setTimeout(() => { if (state.running) nextQuestion(); }, 450);
    }

    function checkStageAdvanceOrFinish() {
      const info = stageInfo();
      if (state.gotCorrectThisStage < info.needCorrect) return;

      if (state.stageIndex < STAGES.length - 1) {
        state.stageIndex += 1;
        state.gotCorrectThisStage = 0;
        AudioFX.stageUp();
        setToast(`${STAGES[state.stageIndex].stage}ë‹¨ê³„ë¡œ ì´ë™!`, 'info');
        updateHUD();
        nextQuestion();
        return;
      }

      state.running = false;
      state.phase = 'finished';
      clearTimers();
      stopQuestionTimer();
      setInputLocked(true);

      questionLine.classList.remove('blink');
      questionLine.textContent = `JACKPOT! ì™„ë£Œ ğŸ°  (ì •ë‹µ ${state.correct} / ì˜¤ë‹µ ${state.wrong} / íƒ€ì„ì•„ì›ƒ ${state.timeout})`;
      setRingProgress(100, 'END');
      setToast('ì „ì²´ ë‹¨ê³„ ì™„ë£Œ!', 'success');

      btnStart.disabled = false;
      stageSelect.disabled = false;
    }

    function submitAnswer() {
      if (!state.running) return;
      if (state.phase !== 'answering') return;
      if (state.lockInput) return;

      const raw = answerInput.value;
      if (raw === '' || raw == null) {
        setToast('ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”.', 'secondary');
        answerInput.focus();
        return;
      }

      const user = Number(raw);
      const ans = state.current.answer;

      const remain = remainSecNow();
      stopQuestionTimer();
      setInputLocked(true);

      state.attempt += 1;

      if (Number.isFinite(user) && user === ans) {
        state.correct += 1;
        state.streak += 1;
        state.gotCorrectThisStage += 1;

        // score: ê¸°ë³¸ 10 + ë‚¨ì€ì‹œê°„ ë³´ë„ˆìŠ¤(ìµœëŒ€ 10) + ì—°ì† ë³´ë„ˆìŠ¤
        const timeBonus = remain == null ? 0 : Math.floor(Math.min(10, remain));
        const streakBonus = Math.min(10, state.streak);
        state.score += (10 + timeBonus + streakBonus);

        AudioFX.correct();
        setToast(`ì •ë‹µ! (+${10 + timeBonus + streakBonus}ì )`, 'success');

        logAttempt({ input: user, result: 'ì •ë‹µ', remainSec: remain ?? null });

        updateHUD();
        checkStageAdvanceOrFinish();
        if (state.running) setTimeout(() => nextQuestion(), 320);
      } else {
        state.wrong += 1;
        state.streak = 0;
        state.score = Math.max(0, state.score - 2);

        AudioFX.wrong();
        setToast(`ì˜¤ë‹µ! ì •ë‹µ: ${ans}`, 'danger');

        questionLine.classList.add('shake');
        setTimeout(() => questionLine.classList.remove('shake'), 380);

        logAttempt({ input: user, result: 'ì˜¤ë‹µ', remainSec: remain ?? null });

        updateHUD();
        setTimeout(() => { if (state.running) nextQuestion(); }, 450);
      }
    }

    // --------------------------------------------
    // Game start / restart
    // --------------------------------------------
    function startGameFromSelectedStage() {
      const selected = Number(stageSelect.value);
      const idx = STAGES.findIndex(s => s.stage === selected);
      state.stageIndex = (idx >= 0) ? idx : 0;

      state.running = true;
      state.phase = 'idle';
      state.gotCorrectThisStage = 0;

      state.streak = 0;
      state.score = 0;

      state.correct = 0;
      state.wrong = 0;
      state.timeout = 0;
      state.attempt = 0;

      state.current = null;

      clearTimers();
      stopQuestionTimer();
      setRingProgress(0, '-');
      windowA.textContent = '-';
      windowB.textContent = '-';
      opSymbol.textContent = '?';

      btnStart.disabled = true;
      stageSelect.disabled = true;

      updateHUD();
      setToast(`${STAGES[state.stageIndex].stage}ë‹¨ê³„ë¶€í„° ì‹œì‘!`, 'primary');
      nextQuestion();
    }

    function restartCurrentStage() {
      if (!state.running) {
        // running ì•„ë‹ˆë©´ ì„ íƒëœ ë‹¨ê³„ ê¸°ì¤€ìœ¼ë¡œ ì‹œì‘
        startGameFromSelectedStage();
        return;
      }

      clearTimers();
      stopQuestionTimer();

      state.gotCorrectThisStage = 0;
      state.streak = 0;
      // ì ìˆ˜/ì „ì²´ ì •ë‹µì˜¤ë‹µì€ ìœ ì§€í• ì§€ ì• ë§¤ -> "í˜„ì¬ ë‹¨ê³„ ì¬ì‹œì‘"ì€ ëˆ„ì  ìœ ì§€ë¡œ ì²˜ë¦¬
      updateHUD();

      setToast(`${stageInfo().stage}ë‹¨ê³„ ì¬ì‹œì‘!`, 'info');
      nextQuestion();
    }

    function restartAll() {
      state.running = false;
      state.phase = 'idle';
      clearTimers();
      stopQuestionTimer();

      state.stageIndex = 0;
      state.gotCorrectThisStage = 0;

      state.streak = 0;
      state.score = 0;
      state.correct = 0;
      state.wrong = 0;
      state.timeout = 0;
      state.attempt = 0;

      state.current = null;

      btnStart.disabled = false;
      stageSelect.disabled = false;

      setInputLocked(true);
      answerInput.value = '';

      windowA.textContent = '-';
      windowB.textContent = '-';
      opSymbol.textContent = '?';
      questionLine.textContent = 'ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”';
      questionLine.classList.remove('blink');

      setRingProgress(0, '-');
      progressBar.style.width = '0%';
      progressBar.classList.remove('bg-success');
      progressBar.classList.add('bg-info');

      updateHUD();
      setToast('ì²˜ìŒë¶€í„° ë¦¬ì…‹ ì™„ë£Œ', 'secondary');
    }

    // --------------------------------------------
    // CSV
    // --------------------------------------------
    function downloadCsv() {
      const rows = [...state.log].reverse(); // oldest first
      const header = ['no','stage','problem','input','answer','result','remainSec'];
      const esc = (v) => {
        const s = String(v ?? '');
        const needs = /[",\n]/.test(s);
        const q = s.replaceAll('"', '""');
        return needs ? `"${q}"` : q;
      };

      const csv = [
        header.join(','),
        ...rows.map(r => header.map(h => esc(r[h])).join(',')),
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'math-slot-log.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();

      URL.revokeObjectURL(url);
    }

    // --------------------------------------------
    // Events
    // --------------------------------------------
    btnStart.addEventListener('click', () => startGameFromSelectedStage());
    btnRestartStage.addEventListener('click', () => restartCurrentStage());
    btnRestartAll.addEventListener('click', () => restartAll());

    answerForm.addEventListener('submit', (e) => {
      e.preventDefault();
      submitAnswer();
    });

    btnClearLog.addEventListener('click', () => {
      state.log = [];
      renderLog();
      setToast('ë¡œê·¸ë¥¼ ë¹„ì› ìŠµë‹ˆë‹¤.', 'secondary');
    });

    btnDownloadCsv.addEventListener('click', () => {
      downloadCsv();
      setToast('CSV ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.', 'info');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') restartAll();
      if (e.key === 'Enter') AudioFX.unlock(); // allow audio on first interaction
    });

    // init
    function init() {
      renderLog();
      restartAll();
    }
    init();
  </script>
</body>
</html>
